{% extends "modern_base.html" %}
{% block title %}Scenario Management Center - Kavak{% endblock %}

{% block extra_css %}
<style>
    /* Scenario Center Styles */
    .scenario-center {
        padding: 2rem 0;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .center-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .center-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.5rem;
    }
    
    .center-subtitle {
        color: #666;
        font-size: 1.125rem;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: #1451EC;
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1451EC;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-detail {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
        font-size: 0.875rem;
        color: #666;
    }
    
    /* Scenario Table */
    .scenario-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    
    .table-header {
        background: #f8f9fa;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .table-title {
        font-weight: 600;
        color: #333;
    }
    
    .table-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .scenario-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        align-items: center;
        transition: background 0.2s;
    }
    
    .scenario-row:hover {
        background: #f8f9fa;
    }
    
    .scenario-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .scenario-customer {
        font-size: 0.875rem;
        color: #666;
    }
    
    .scenario-metric {
        text-align: center;
    }
    
    .scenario-metric-value {
        font-weight: 600;
        color: #333;
    }
    
    .scenario-metric-label {
        font-size: 0.75rem;
        color: #666;
    }
    
    .scenario-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
    
    .action-btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        background: #f8f9fa;
        border-color: #1451EC;
        color: #1451EC;
    }
    
    /* Activity Timeline */
    .activity-timeline {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .timeline-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .timeline-title {
        font-weight: 600;
        color: #333;
    }
    
    .timeline-item {
        display: flex;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .timeline-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e8f0fe;
        color: #1451EC;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .timeline-content {
        flex: 1;
    }
    
    .timeline-action {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .timeline-details {
        font-size: 0.875rem;
        color: #666;
    }
    
    .timeline-time {
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.25rem;
    }
    
    /* Filter Pills */
    .filter-pills {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .filter-pill {
        padding: 0.5rem 1rem;
        border-radius: 999px;
        background: white;
        border: 1px solid #e0e0e0;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-pill:hover {
        border-color: #1451EC;
        color: #1451EC;
    }
    
    .filter-pill.active {
        background: #1451EC;
        color: white;
        border-color: #1451EC;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #666;
    }
    
    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .empty-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .empty-message {
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="scenario-center">
    <div class="container">
        <!-- Header -->
        <div class="center-header">
            <h1 class="center-title">Scenario Management Center</h1>
            <p class="center-subtitle">Track, compare, and analyze all your saved deal scenarios</p>
        </div>
        
        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_scenarios }}</div>
                <div class="stat-label">Total Scenarios</div>
                <div class="stat-detail">
                    Across {{ stats.unique_customers }} customers
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ "%.1f"|format(stats.avg_scenarios_per_customer) }}</div>
                <div class="stat-label">Avg Scenarios/Customer</div>
                <div class="stat-detail">
                    Most active: {{ stats.most_active_customers[0][0] if stats.most_active_customers else 'N/A' }}
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ "%.1f"|format(stats.avg_service_fee * 100) }}%</div>
                <div class="stat-label">Avg Service Fee</div>
                <div class="stat-detail">
                    CXA: {{ "%.1f"|format(stats.avg_cxa_fee * 100) }}%
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ stats.most_common_term }}mo</div>
                <div class="stat-label">Most Common Term</div>
                <div class="stat-detail">
                    From saved scenarios
                </div>
            </div>
        </div>
        
        <!-- Main Content Grid -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <!-- Scenarios Table -->
            <div>
                <!-- Filter Pills -->
                <div class="filter-pills">
                    <div class="filter-pill active" onclick="filterScenarios('all')">All Scenarios</div>
                    <div class="filter-pill" onclick="filterScenarios('today')">Today</div>
                    <div class="filter-pill" onclick="filterScenarios('week')">This Week</div>
                    <div class="filter-pill" onclick="filterScenarios('month')">This Month</div>
                </div>
                
                <!-- Scenarios Table -->
                <div class="scenario-table">
                    <div class="table-header">
                        <div class="table-title">Saved Scenarios</div>
                        <div class="table-actions">
                            <input type="text" placeholder="Search scenarios..." 
                                   style="padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 6px;">
                            <button class="btn btn-sm btn-primary" onclick="exportScenarios()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div id="scenarios-list">
                        {% if scenarios %}
                            {% for scenario in scenarios %}
                            <div class="scenario-row" data-scenario-id="{{ scenario.id }}">
                                <div>
                                    <div class="scenario-name">{{ scenario.name }}</div>
                                    <div class="scenario-customer">{{ scenario.customer_id }}</div>
                                </div>
                                
                                <div class="scenario-metric">
                                    <div class="scenario-metric-value">{{ "%.1f"|format(scenario.configuration.service_fee_pct * 100) }}%</div>
                                    <div class="scenario-metric-label">Service Fee</div>
                                </div>
                                
                                <div class="scenario-metric">
                                    <div class="scenario-metric-value">{{ scenario.configuration.term_months|default(48) }}mo</div>
                                    <div class="scenario-metric-label">Term</div>
                                </div>
                                
                                <div class="scenario-metric">
                                    <div class="scenario-metric-value">${{ "{:,.0f}".format(scenario.configuration.monthly_payment|default(0)) }}</div>
                                    <div class="scenario-metric-label">Monthly</div>
                                </div>
                                
                                <div class="scenario-metric">
                                    <div class="scenario-metric-value">{{ scenario.created_at[:10] }}</div>
                                    <div class="scenario-metric-label">Created</div>
                                </div>
                                
                                <div class="scenario-actions">
                                    <button class="action-btn" onclick="viewScenario('{{ scenario.id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn" onclick="compareScenario('{{ scenario.id }}')">
                                        <i class="fas fa-columns"></i>
                                    </button>
                                    <button class="action-btn" onclick="deleteScenario('{{ scenario.id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-folder-open empty-icon"></i>
                                <div class="empty-title">No Scenarios Yet</div>
                                <p class="empty-message">Start creating scenarios in the Deal Architect to see them here.</p>
                                <a href="/deal-architect" class="btn btn-primary">
                                    Go to Deal Architect
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Activity Timeline -->
            <div class="activity-timeline">
                <div class="timeline-header">
                    <h3 class="timeline-title">Recent Activity</h3>
                </div>
                
                <div id="activity-timeline">
                    {% for activity in recent_activity %}
                    <div class="timeline-item">
                        <div class="timeline-icon">
                            <i class="fas fa-save"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-action">
                                Scenario created: <strong>{{ activity.scenario_name }}</strong>
                            </div>
                            <div class="timeline-details">
                                Customer: {{ activity.customer_id }}
                                <br>
                                Config: {{ "%.1f"|format(activity.configuration.service_fee_pct * 100) }}% service fee, 
                                {{ activity.configuration.term_months|default(48) }}mo term
                            </div>
                            <div class="timeline-time">{{ activity.timestamp[:16] }}</div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not recent_activity %}
                    <div style="text-align: center; padding: 2rem; color: #999;">
                        <i class="fas fa-clock" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p>No recent activity</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State management
let currentFilter = 'all';
let selectedScenarios = [];

// Filter scenarios by time period
function filterScenarios(period) {
    currentFilter = period;
    
    // Update active filter pill
    document.querySelectorAll('.filter-pill').forEach(pill => {
        pill.classList.toggle('active', pill.textContent.toLowerCase().includes(period));
    });
    
    // Filter scenarios (would implement actual filtering logic)
    console.log('Filtering by:', period);
}

// View scenario details
function viewScenario(scenarioId) {
    // Navigate to customer detail with scenario loaded
    fetch(`/api/scenarios/${scenarioId}`)
        .then(res => res.json())
        .then(scenario => {
            window.location.href = `/deal-architect/${scenario.customer_id}?scenario=${scenarioId}`;
        });
}

// Add scenario to comparison
function compareScenario(scenarioId) {
    if (selectedScenarios.includes(scenarioId)) {
        selectedScenarios = selectedScenarios.filter(id => id !== scenarioId);
    } else {
        selectedScenarios.push(scenarioId);
    }
    
    if (selectedScenarios.length >= 2) {
        // Navigate to comparison view
        window.location.href = `/scenarios/compare?ids=${selectedScenarios.join(',')}`;
    } else {
        alert('Select at least 2 scenarios to compare');
    }
}

// Delete scenario
function deleteScenario(scenarioId) {
    if (!confirm('Are you sure you want to delete this scenario?')) {
        return;
    }
    
    fetch(`/api/scenarios/${scenarioId}`, {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
        // Remove from UI
        document.querySelector(`[data-scenario-id="${scenarioId}"]`).remove();
        alert('Scenario deleted successfully');
    })
    .catch(err => {
        alert('Error deleting scenario: ' + err.message);
    });
}

// Export scenarios
function exportScenarios() {
    // Would implement CSV/Excel export
    alert('Export feature coming soon!');
}

// Search scenarios
document.querySelector('input[placeholder="Search scenarios..."]').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    document.querySelectorAll('.scenario-row').forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? 'grid' : 'none';
    });
});
</script>
{% endblock %}