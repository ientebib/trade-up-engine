{% extends "modern_base.html" %}
{% block title %}Deal Architect - {{ customer.full_name or customer.customer_id }} - Kavak{% endblock %}

{% block extra_css %}
<style>
    /* Deal Architect Workspace Styles */
    body {
        overflow: hidden;
        height: 100vh;
    }
    
    .workspace {
        height: 100vh;
        display: grid;
        grid-template-rows: 60px 1fr;
        background: #f8f9fa;
    }
    
    .workspace-header {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        padding: 0 2rem;
        gap: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .workspace-body {
        display: grid;
        grid-template-columns: 350px 1fr 350px;
        gap: 0;
        height: calc(100vh - 60px);
        overflow: hidden;
    }
    
    .panel {
        background: white;
        overflow-y: auto;
        border-right: 1px solid #e0e0e0;
    }
    
    .panel:last-child {
        border-right: none;
        border-left: 1px solid #e0e0e0;
    }
    
    .panel-header {
        position: sticky;
        top: 0;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 1rem 1.5rem;
        z-index: 10;
    }
    
    .panel-body {
        padding: 1.5rem;
    }
    
    /* Configuration Panel */
    .config-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .config-section:last-child {
        border-bottom: none;
    }
    
    .config-section h4 {
        margin: 0 0 1rem 0;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #666;
    }
    
    .slider-group {
        margin-bottom: 1.25rem;
    }
    
    .slider-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .slider-value {
        font-weight: 600;
        color: #1451EC;
        font-size: 0.875rem;
    }
    
    input[type="range"] {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #1451EC;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Results Panel */
    .results-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1451EC;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: #666;
        margin-top: 0.25rem;
    }
    
    .offer-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .offer-card:hover {
        border-color: #1451EC;
        box-shadow: 0 4px 12px rgba(20,81,236,0.1);
    }
    
    .offer-card.selected {
        border-color: #1451EC;
        background: #f0f5ff;
    }
    
    .offer-tier {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .tier-refresh {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .tier-upgrade {
        background: #fff3e0;
        color: #ef6c00;
    }
    
    .tier-max {
        background: #fce4ec;
        color: #c2185b;
    }
    
    /* Comparison Panel */
    .comparison-slot {
        background: #f8f9fa;
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1rem;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .comparison-slot.filled {
        background: white;
        border: 1px solid #e0e0e0;
        padding: 1rem;
        text-align: left;
    }
    
    /* Live Indicators */
    .live-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* Payment Display */
    .payment-display {
        background: #1451EC;
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    
    .payment-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .payment-delta {
        font-size: 1.125rem;
        opacity: 0.9;
    }
    
    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .quick-action {
        padding: 0.5rem;
        font-size: 0.875rem;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .quick-action:hover {
        background: #f8f9fa;
        border-color: #1451EC;
    }
    
    /* Smart Inventory Browser Styles */
    .vehicle-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .vehicle-card:hover {
        border-color: #1451EC;
        box-shadow: 0 4px 12px rgba(20,81,236,0.1);
        transform: translateY(-1px);
    }
    
    .vehicle-card.selected {
        border-color: #1451EC;
        background: #f0f5ff;
    }
    
    .vehicle-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.75rem;
    }
    
    .vehicle-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .vehicle-subtitle {
        font-size: 0.875rem;
        color: #666;
    }
    
    .vehicle-price {
        text-align: right;
    }
    
    .vehicle-price-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
    }
    
    .vehicle-price-label {
        font-size: 0.75rem;
        color: #666;
    }
    
    .vehicle-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f0f0f0;
    }
    
    .vehicle-stat {
        text-align: center;
    }
    
    .vehicle-stat-value {
        font-weight: 600;
        color: #333;
        font-size: 0.875rem;
    }
    
    .vehicle-stat-label {
        font-size: 0.75rem;
        color: #666;
        margin-top: 0.125rem;
    }
    
    .payment-indicator {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .payment-match {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .payment-increase {
        background: #fff3e0;
        color: #ef6c00;
    }
    
    .payment-high {
        background: #fce4ec;
        color: #c2185b;
    }
    
    .filter-badge {
        background: #1451EC;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        display: inline-block;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="workspace">
    <!-- Header -->
    <div class="workspace-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <h1 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Deal Architect</h1>
            <span class="live-indicator"></span>
            <span style="color: #666; font-size: 0.875rem;">Live Mode</span>
        </div>
        
        <div style="flex: 1; display: flex; align-items: center; gap: 1rem;">
            <div style="padding: 0.5rem 1rem; background: #f8f9fa; border-radius: 6px;">
                <strong>{{ customer.full_name or customer.customer_id }}</strong>
                <span style="margin-left: 1rem; color: #666;">
                    Current: ${{ "{:,.0f}".format(customer.current_monthly_payment) }}/mo
                </span>
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button class="btn btn-secondary" onclick="resetAll()">
                <i class="fas fa-undo"></i> Reset
            </button>
            <button class="btn btn-primary" onclick="exportComparison()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
    
    <!-- Main Workspace -->
    <div class="workspace-body">
        <!-- Left Panel: Configuration -->
        <div class="panel">
            <div class="panel-header">
                <h3 style="margin: 0; font-size: 1.125rem;">Configuration</h3>
            </div>
            <div class="panel-body">
                <!-- Current Payment Display -->
                <div class="payment-display">
                    <div class="payment-value" id="current-payment">
                        $<span id="calculated-payment">{{ "{:,.0f}".format(customer.current_monthly_payment) }}</span>
                    </div>
                    <div class="payment-delta" id="payment-delta">
                        Calculating...
                    </div>
                </div>
                
                <!-- Loan Terms -->
                <div class="config-section">
                    <h4>Loan Terms</h4>
                    <div class="slider-group">
                        <label>Term</label>
                        <select id="term-select" class="form-control" onchange="updateCalculations()">
                            <option value="36">36 months</option>
                            <option value="48" selected>48 months</option>
                            <option value="60">60 months</option>
                            <option value="72">72 months</option>
                        </select>
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <label>Interest Rate</label>
                            <span class="slider-value" id="interest-value">18.0%</span>
                        </div>
                        <input type="range" id="interest-slider" min="10" max="30" step="0.5" value="18" oninput="updateSlider(this, 'interest-value', '%'); updateCalculations()">
                    </div>
                </div>
                
                <!-- Fees Configuration -->
                <div class="config-section">
                    <h4>Fees & Commissions</h4>
                    <div class="slider-group">
                        <div class="slider-label">
                            <label>Service Fee</label>
                            <span class="slider-value" id="service-fee-value">4.0%</span>
                        </div>
                        <input type="range" id="service-fee-slider" min="0" max="5" step="0.1" value="4" oninput="updateSlider(this, 'service-fee-value', '%'); updateCalculations()">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <label>CXA (Opening Fee)</label>
                            <span class="slider-value" id="cxa-value">4.0%</span>
                        </div>
                        <input type="range" id="cxa-slider" min="0" max="5" step="0.1" value="4" oninput="updateSlider(this, 'cxa-value', '%'); updateCalculations()">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <label>CAC Bonus</label>
                            <span class="slider-value" id="cac-value">$0</span>
                        </div>
                        <input type="range" id="cac-slider" min="0" max="10000" step="500" value="0" oninput="updateSlider(this, 'cac-value', '$'); updateCalculations()">
                    </div>
                </div>
                
                <!-- Products -->
                <div class="config-section">
                    <h4>Products</h4>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <label>Kavak Total</label>
                        <div class="toggle" id="kavak-total-toggle" onclick="toggleKavakTotal(); updateCalculations()"></div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <label>Insurance Amount</label>
                            <span class="slider-value" id="insurance-value">$10,999</span>
                        </div>
                        <input type="range" id="insurance-slider" min="8000" max="20000" step="500" value="10999" oninput="updateSlider(this, 'insurance-value', '$'); updateCalculations()">
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="config-section">
                    <h4>Quick Actions</h4>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="applyPreset('conservative')">
                            Conservative
                        </button>
                        <button class="quick-action" onclick="applyPreset('aggressive')">
                            Aggressive
                        </button>
                        <button class="quick-action" onclick="applyPreset('no-fees')">
                            No Fees
                        </button>
                        <button class="quick-action" onclick="applyPreset('max-term')">
                            Max Term
                        </button>
                    </div>
                </div>
                
                <!-- Save Configuration -->
                <button class="btn btn-primary" onclick="saveCurrentConfig()" style="width: 100%;">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
        
        <!-- Center Panel: Smart Inventory Browser -->
        <div class="panel" style="background: #f8f9fa;">
            <div class="panel-header">
                <h3 style="margin: 0; font-size: 1.125rem;">Smart Inventory Browser</h3>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                    <input type="text" id="search-inventory" placeholder="Search by brand, model, year..." 
                           style="flex: 1; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 6px;"
                           onkeyup="debounceSearch()">
                    <button class="btn btn-sm" onclick="toggleAdvancedFilters()" style="background: white; border: 1px solid #e0e0e0;">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                </div>
                
                <!-- Advanced Filters (Hidden by default) -->
                <div id="advanced-filters" style="display: none; margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <!-- Payment Range -->
                        <div>
                            <label style="font-size: 0.75rem; color: #666;">Payment Change</label>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem;">
                                <input type="number" id="payment-min" placeholder="-10%" value="-10" style="width: 60px; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                                <span>to</span>
                                <input type="number" id="payment-max" placeholder="25%" value="25" style="width: 60px; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <!-- Price Range -->
                        <div>
                            <label style="font-size: 0.75rem; color: #666;">Price Range</label>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem;">
                                <input type="number" id="price-min" placeholder="Min" style="width: 80px; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                                <span>to</span>
                                <input type="number" id="price-max" placeholder="Max" style="width: 80px; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <!-- Year Range -->
                        <div>
                            <label style="font-size: 0.75rem; color: #666;">Year</label>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem;">
                                <input type="number" id="year-min" placeholder="2020" min="2015" max="2025" style="width: 80px; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                                <span>to</span>
                                <input type="number" id="year-max" placeholder="2025" min="2015" max="2025" style="width: 80px; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <!-- Max KM -->
                        <div>
                            <label style="font-size: 0.75rem; color: #666;">Max Kilometers</label>
                            <input type="number" id="max-km" placeholder="50000" style="width: 100%; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 0.25rem;">
                        </div>
                        
                        <!-- Vehicle Type -->
                        <div>
                            <label style="font-size: 0.75rem; color: #666;">Vehicle Type</label>
                            <select id="vehicle-types" multiple style="width: 100%; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 0.25rem; height: 60px;">
                                <option value="SUV">SUV</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Truck">Truck</option>
                                <option value="Hatchback">Hatchback</option>
                            </select>
                        </div>
                        
                        <!-- Sort By -->
                        <div>
                            <label style="font-size: 0.75rem; color: #666;">Sort By</label>
                            <select id="sort-by" style="width: 100%; padding: 0.25rem; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 0.25rem;">
                                <option value="payment_delta">Payment Match</option>
                                <option value="npv">NPV (Highest)</option>
                                <option value="payment">Monthly Payment</option>
                                <option value="price">Price</option>
                                <option value="year">Year</option>
                                <option value="km">Kilometers</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-sm" onclick="clearFilters()" style="background: white; border: 1px solid #e0e0e0;">
                            Clear
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="applyFilters()">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                <!-- Stats -->
                <div class="results-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-offers">0</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="viable-offers">0</div>
                        <div class="stat-label">Showing</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-npv">$0</div>
                        <div class="stat-label">Avg NPV</div>
                    </div>
                </div>
                
                <!-- Category Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn btn-sm active" onclick="filterByCategory('all')" data-category="all">All</button>
                    <button class="btn btn-sm" onclick="filterByCategory('perfect_match')" data-category="perfect_match">
                        Perfect Match <span id="count-perfect" style="opacity: 0.7;">(0)</span>
                    </button>
                    <button class="btn btn-sm" onclick="filterByCategory('slight_increase')" data-category="slight_increase">
                        Slight+ <span id="count-slight" style="opacity: 0.7;">(0)</span>
                    </button>
                    <button class="btn btn-sm" onclick="filterByCategory('moderate_increase')" data-category="moderate_increase">
                        Moderate+ <span id="count-moderate" style="opacity: 0.7;">(0)</span>
                    </button>
                </div>
                
                <!-- Results Container -->
                <div id="results-container" style="max-height: calc(100vh - 380px); overflow-y: auto;">
                    <div style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Loading inventory...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Comparison -->
        <div class="panel">
            <div class="panel-header">
                <h3 style="margin: 0; font-size: 1.125rem;">Comparison</h3>
            </div>
            <div class="panel-body">
                <!-- Saved Scenarios -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="font-size: 0.875rem; text-transform: uppercase; color: #666; margin-bottom: 1rem;">
                        Saved Scenarios ({{ saved_scenarios|length }})
                    </h4>
                    <div id="saved-scenarios" style="max-height: 200px; overflow-y: auto;">
                        {% for scenario in saved_scenarios %}
                        <div class="quick-action" onclick="loadScenario('{{ scenario.id }}')" style="margin-bottom: 0.5rem;">
                            <div style="font-weight: 500;">{{ scenario.name }}</div>
                            <div style="font-size: 0.75rem; color: #666;">
                                ${{ "{:,.0f}".format(scenario.configuration.monthly_payment|default(0)) }}/mo
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Comparison Slots -->
                <h4 style="font-size: 0.875rem; text-transform: uppercase; color: #666; margin-bottom: 1rem;">
                    Compare Offers
                </h4>
                <div id="comparison-slots">
                    <div class="comparison-slot" data-slot="1">
                        <div style="color: #999;">
                            <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>Click a vehicle to compare</p>
                        </div>
                    </div>
                    <div class="comparison-slot" data-slot="2">
                        <div style="color: #999;">
                            <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>Click a vehicle to compare</p>
                        </div>
                    </div>
                    <div class="comparison-slot" data-slot="3">
                        <div style="color: #999;">
                            <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>Click a vehicle to compare</p>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Actions -->
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="clearComparison()" style="width: 100%; margin-bottom: 0.5rem;">
                        Clear Comparison
                    </button>
                    <button class="btn btn-primary" onclick="generateReport()" style="width: 100%;">
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Customer data
const customerId = '{{ customer.customer_id }}';
const currentPayment = {{ customer.current_monthly_payment }};
const vehicleEquity = {{ customer.vehicle_equity }};

// State management
let currentOffers = [];
let allVehicles = [];
let currentSearchResults = [];
let activeFilters = {};
let comparisonSlots = [null, null, null];
let updateTimer = null;
let searchTimer = null;
let currentCategory = 'all';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Deal Architect initialized');
    loadInitialData();
    setupRealtimeUpdates();
});

// Real-time calculation updates
function updateCalculations() {
    // Debounce updates
    clearTimeout(updateTimer);
    updateTimer = setTimeout(() => {
        calculatePayments();
    }, 300);
}

function calculatePayments() {
    // Get current configuration
    const config = getCurrentConfig();
    
    // Show loading state
    document.getElementById('payment-delta').textContent = 'Calculating...';
    
    // Make real-time calculation request
    fetch('/api/calculate-payment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            customer_id: customerId,
            car_id: 'sample', // This would be the selected car
            term: parseInt(config.term),
            service_fee_pct: config.service_fee_pct,
            cxa_pct: config.cxa_pct,
            cac_bonus: config.cac_bonus,
            kavak_total_enabled: config.kavak_total_enabled,
            insurance_amount: config.insurance_amount,
            interest_rate: config.interest_rate
        })
    })
    .then(res => res.json())
    .then(data => {
        updatePaymentDisplay(data);
        refreshOffers();
    })
    .catch(err => {
        console.error('Calculation error:', err);
    });
}

function getCurrentConfig() {
    return {
        term: document.getElementById('term-select').value,
        interest_rate: parseFloat(document.getElementById('interest-slider').value) / 100,
        service_fee_pct: parseFloat(document.getElementById('service-fee-slider').value) / 100,
        cxa_pct: parseFloat(document.getElementById('cxa-slider').value) / 100,
        cac_bonus: parseInt(document.getElementById('cac-slider').value),
        kavak_total_enabled: document.getElementById('kavak-total-toggle').classList.contains('active'),
        insurance_amount: parseInt(document.getElementById('insurance-slider').value)
    };
}

function updatePaymentDisplay(data) {
    if (data.viable) {
        document.getElementById('calculated-payment').textContent = Math.round(data.monthly_payment).toLocaleString();
        const delta = ((data.monthly_payment / currentPayment) - 1) * 100;
        document.getElementById('payment-delta').innerHTML = `
            ${delta > 0 ? '+' : ''}${delta.toFixed(1)}% vs current
            <br>
            <span style="font-size: 0.875rem; opacity: 0.8;">
                Without fees: $${Math.round(data.payment_without_fees).toLocaleString()}
            </span>
        `;
    } else {
        document.getElementById('payment-delta').textContent = 'Configuration not viable';
    }
}

function updateSlider(slider, displayId, prefix) {
    const value = slider.value;
    const display = document.getElementById(displayId);
    if (prefix === '$') {
        display.textContent = '$' + parseInt(value).toLocaleString();
    } else {
        display.textContent = value + prefix;
    }
}

function toggleKavakTotal() {
    document.getElementById('kavak-total-toggle').classList.toggle('active');
}

function loadInitialData() {
    // Don't search on load - show placeholder instead
    document.getElementById('results-container').innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #999;">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Start typing to search inventory or use filters</p>
        </div>
    `;
}

function performSearch(searchTerm = '') {
    if (isSearching) return;  // Prevent concurrent searches
    
    isSearching = true;
    const config = getCurrentConfig();
    
    // Show loading
    document.getElementById('results-container').innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #999;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Searching inventory...</p>
        </div>
    `;
    
    // Use live search API for real-time NPV calculations
    fetch('/api/search-inventory-live', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            customer_id: customerId,
            search_term: searchTerm,
            config: config,
            limit: 50
        })
    })
    .then(res => res.json())
    .then(data => {
        allVehicles = data.vehicles || [];
        currentSearchResults = allVehicles;
        displayVehicles();
    })
    .catch(err => {
        console.error('Error searching inventory:', err);
        document.getElementById('results-container').innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #f44336;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p>Error loading inventory. Please try again.</p>
            </div>
        `;
    })
    .finally(() => {
        isSearching = false;  // Reset flag
    });
}

function refreshOffers() {
    // This is now an alias for performSearch
    performSearch(document.getElementById('search-inventory').value);
}

function displayVehicles() {
    let vehicles = currentCategory === 'all' ? currentSearchResults : filterVehiclesByCategory(currentCategory);
    
    let html = '';
    let totalNPV = 0;
    let categories = {
        perfect_match: 0,
        slight_increase: 0,
        moderate_increase: 0,
        stretch: 0
    };
    
    vehicles.forEach(vehicle => {
        const delta = vehicle.payment_delta || 0;
        totalNPV += vehicle.npv || 0;
        
        // Categorize
        if (delta >= -0.05 && delta <= 0.05) {
            categories.perfect_match++;
        } else if (delta > 0.05 && delta <= 0.15) {
            categories.slight_increase++;
        } else if (delta > 0.15 && delta <= 0.25) {
            categories.moderate_increase++;
        } else {
            categories.stretch++;
        }
        
        html += createVehicleCard(vehicle);
    });
    
    // Update stats
    document.getElementById('total-offers').textContent = currentSearchResults.length;
    document.getElementById('viable-offers').textContent = vehicles.length;
    document.getElementById('avg-npv').textContent = vehicles.length > 0 ? 
        '$' + Math.round(totalNPV / vehicles.length).toLocaleString() : '$0';
    
    // Update category counts
    document.getElementById('count-perfect').textContent = `(${categories.perfect_match})`;
    document.getElementById('count-slight').textContent = `(${categories.slight_increase})`;
    document.getElementById('count-moderate').textContent = `(${categories.moderate_increase})`;
    
    // Display vehicles
    document.getElementById('results-container').innerHTML = html || 
        '<p style="text-align: center; color: #999; padding: 3rem;">No vehicles found. Try adjusting your search or filters.</p>';
}

function createVehicleCard(vehicle) {
    const delta = vehicle.payment_delta || 0;
    let paymentClass = 'payment-match';
    if (delta > 0.15) paymentClass = 'payment-high';
    else if (delta > 0.05) paymentClass = 'payment-increase';
    
    const deltaPercent = (delta * 100).toFixed(1);
    const deltaDisplay = delta > 0 ? `+${deltaPercent}%` : `${deltaPercent}%`;
    
    return `
        <div class="vehicle-card" onclick="selectVehicle(${JSON.stringify(vehicle).replace(/"/g, '&quot;')})">
            <span class="payment-indicator ${paymentClass}">${deltaDisplay}</span>
            
            <div class="vehicle-header">
                <div>
                    <div class="vehicle-title">${vehicle.car_model || vehicle.model}</div>
                    <div class="vehicle-subtitle">${vehicle.year} â€¢ ${Math.round((vehicle.kilometers || 0) / 1000)}k km</div>
                </div>
                <div class="vehicle-price">
                    <div class="vehicle-price-value">$${Math.round(vehicle.car_price).toLocaleString()}</div>
                    <div class="vehicle-price-label">Vehicle Price</div>
                </div>
            </div>
            
            <div class="vehicle-stats">
                <div class="vehicle-stat">
                    <div class="vehicle-stat-value">$${Math.round(vehicle.monthly_payment).toLocaleString()}</div>
                    <div class="vehicle-stat-label">Monthly</div>
                </div>
                <div class="vehicle-stat">
                    <div class="vehicle-stat-value">${vehicle.term}mo</div>
                    <div class="vehicle-stat-label">Term</div>
                </div>
                <div class="vehicle-stat">
                    <div class="vehicle-stat-value" style="color: #4caf50;">$${Math.round(vehicle.npv).toLocaleString()}</div>
                    <div class="vehicle-stat-label">NPV</div>
                </div>
                <div class="vehicle-stat">
                    <div class="vehicle-stat-value">${Math.round(vehicle.down_payment_pct * 100)}%</div>
                    <div class="vehicle-stat-label">Down</div>
                </div>
            </div>
        </div>
    `;
}

function selectVehicle(vehicle) {
    // Find first empty slot
    for (let i = 0; i < 3; i++) {
        if (!comparisonSlots[i]) {
            addToComparison(vehicle, i);
            break;
        }
    }
}

// Smart Inventory Browser Functions
function toggleAdvancedFilters() {
    const filtersDiv = document.getElementById('advanced-filters');
    filtersDiv.style.display = filtersDiv.style.display === 'none' ? 'block' : 'none';
}

let isSearching = false;

function debounceSearch() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
        const searchTerm = document.getElementById('search-inventory').value;
        if (!isSearching) {  // Prevent multiple simultaneous searches
            performSearch(searchTerm);
        }
    }, 800);  // Increased from 500ms to 800ms
}

function applyFilters() {
    // Collect all filter values
    activeFilters = {
        payment_delta_min: parseFloat(document.getElementById('payment-min').value) / 100 || -0.1,
        payment_delta_max: parseFloat(document.getElementById('payment-max').value) / 100 || 0.25,
        min_price: parseFloat(document.getElementById('price-min').value) || null,
        max_price: parseFloat(document.getElementById('price-max').value) || null,
        min_year: parseInt(document.getElementById('year-min').value) || null,
        max_year: parseInt(document.getElementById('year-max').value) || null,
        max_km: parseFloat(document.getElementById('max-km').value) || null
    };
    
    // Get selected vehicle types
    const vehicleTypesSelect = document.getElementById('vehicle-types');
    const selectedTypes = Array.from(vehicleTypesSelect.selectedOptions).map(opt => opt.value);
    if (selectedTypes.length > 0) {
        activeFilters.vehicle_types = selectedTypes;
    }
    
    // Get sort options
    const sortBy = document.getElementById('sort-by').value;
    
    // Show loading
    document.getElementById('results-container').innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #999;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Applying filters...</p>
        </div>
    `;
    
    // Make filtered search request
    fetch('/api/search-inventory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            customer_id: customerId,
            filters: activeFilters,
            sort_by: sortBy,
            sort_order: 'asc',
            limit: 100
        })
    })
    .then(res => res.json())
    .then(data => {
        // Update vehicles with quick calculations
        allVehicles = data.vehicles || [];
        currentSearchResults = allVehicles;
        
        // Now get full NPV calculations for visible vehicles
        const config = getCurrentConfig();
        return fetch('/api/search-inventory-live', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                customer_id: customerId,
                search_term: document.getElementById('search-inventory').value,
                config: config,
                limit: 50
            })
        });
    })
    .then(res => res.json())
    .then(data => {
        allVehicles = data.vehicles || [];
        currentSearchResults = allVehicles;
        displayVehicles();
        
        // Hide filters after applying
        toggleAdvancedFilters();
    })
    .catch(err => {
        console.error('Error applying filters:', err);
    });
}

function clearFilters() {
    // Reset all filter inputs
    document.getElementById('payment-min').value = '-10';
    document.getElementById('payment-max').value = '25';
    document.getElementById('price-min').value = '';
    document.getElementById('price-max').value = '';
    document.getElementById('year-min').value = '';
    document.getElementById('year-max').value = '';
    document.getElementById('max-km').value = '';
    document.getElementById('vehicle-types').selectedIndex = -1;
    document.getElementById('sort-by').value = 'payment_delta';
    
    // Clear active filters
    activeFilters = {};
    
    // Refresh with no filters
    performSearch(document.getElementById('search-inventory').value);
}

function filterByCategory(category) {
    currentCategory = category;
    
    // Update active button
    document.querySelectorAll('[data-category]').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-category') === category);
    });
    
    // Redisplay vehicles
    displayVehicles();
}

function filterVehiclesByCategory(category) {
    return currentSearchResults.filter(vehicle => {
        const delta = vehicle.payment_delta || 0;
        switch(category) {
            case 'perfect_match':
                return delta >= -0.05 && delta <= 0.05;
            case 'slight_increase':
                return delta > 0.05 && delta <= 0.15;
            case 'moderate_increase':
                return delta > 0.15 && delta <= 0.25;
            default:
                return true;
        }
    });
}

function addToComparison(vehicle, slotIndex) {
    comparisonSlots[slotIndex] = vehicle;
    
    const slot = document.querySelector(`[data-slot="${slotIndex + 1}"]`);
    slot.classList.add('filled');
    slot.innerHTML = `
        <div style="position: relative;">
            <button onclick="removeFromComparison(${slotIndex})" style="position: absolute; top: -0.5rem; right: -0.5rem; background: #f44336; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
            <h5 style="margin: 0 0 0.5rem 0;">${vehicle.car_model || vehicle.model}</h5>
            <div style="font-size: 0.875rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Monthly:</span>
                    <strong>$${Math.round(vehicle.monthly_payment).toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Change:</span>
                    <strong style="color: ${vehicle.payment_delta > 0 ? '#f44336' : '#4caf50'};">
                        ${vehicle.payment_delta > 0 ? '+' : ''}${(vehicle.payment_delta * 100).toFixed(1)}%
                    </strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>NPV:</span>
                    <strong style="color: #4caf50;">$${Math.round(vehicle.npv).toLocaleString()}</strong>
                </div>
            </div>
        </div>
    `;
}

function removeFromComparison(slotIndex) {
    comparisonSlots[slotIndex] = null;
    const slot = document.querySelector(`[data-slot="${slotIndex + 1}"]`);
    slot.classList.remove('filled');
    slot.innerHTML = `
        <div style="color: #999;">
            <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
            <p>Click a vehicle to compare</p>
        </div>
    `;
}

function clearComparison() {
    for (let i = 0; i < 3; i++) {
        removeFromComparison(i);
    }
}

function applyPreset(preset) {
    switch(preset) {
        case 'conservative':
            document.getElementById('service-fee-slider').value = 4;
            document.getElementById('cxa-slider').value = 4;
            document.getElementById('cac-slider').value = 0;
            document.getElementById('term-select').value = '48';
            break;
        case 'aggressive':
            document.getElementById('service-fee-slider').value = 2;
            document.getElementById('cxa-slider').value = 2;
            document.getElementById('cac-slider').value = 5000;
            document.getElementById('term-select').value = '60';
            break;
        case 'no-fees':
            document.getElementById('service-fee-slider').value = 0;
            document.getElementById('cxa-slider').value = 0;
            document.getElementById('cac-slider').value = 0;
            document.getElementById('kavak-total-toggle').classList.remove('active');
            break;
        case 'max-term':
            document.getElementById('term-select').value = '72';
            break;
    }
    
    // Update displays
    updateSlider(document.getElementById('service-fee-slider'), 'service-fee-value', '%');
    updateSlider(document.getElementById('cxa-slider'), 'cxa-value', '%');
    updateSlider(document.getElementById('cac-slider'), 'cac-value', '$');
    
    // Recalculate
    updateCalculations();
}

function saveCurrentConfig() {
    const name = prompt('Enter a name for this configuration:');
    if (!name) return;
    
    const config = getCurrentConfig();
    
    // Save scenario
    fetch('/api/scenarios/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            customer_id: customerId,
            car_id: 'config_only',
            name: name,
            configuration: config,
            notes: 'Deal Architect configuration'
        })
    })
    .then(res => res.json())
    .then(data => {
        alert('Configuration saved!');
        location.reload(); // Refresh to show new scenario
    })
    .catch(err => {
        alert('Error saving configuration: ' + err.message);
    });
}

function filterOffers(tier) {
    // Update active button
    document.querySelectorAll('.btn-sm').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter display
    // Implementation depends on how you want to filter
}

function setupRealtimeUpdates() {
    // Could use WebSockets here for true real-time
    // For now, using debounced updates
}

function resetAll() {
    // Reset all sliders to defaults
    document.getElementById('service-fee-slider').value = 4;
    document.getElementById('cxa-slider').value = 4;
    document.getElementById('cac-slider').value = 0;
    document.getElementById('insurance-slider').value = 10999;
    document.getElementById('interest-slider').value = 18;
    document.getElementById('term-select').value = '48';
    document.getElementById('kavak-total-toggle').classList.add('active');
    
    // Update displays
    document.querySelectorAll('input[type="range"]').forEach(slider => {
        const displayId = slider.id.replace('-slider', '-value');
        const prefix = slider.id.includes('cac') || slider.id.includes('insurance') ? '$' : '%';
        updateSlider(slider, displayId, prefix);
    });
    
    // Clear comparison
    clearComparison();
    
    // Recalculate
    updateCalculations();
}

function exportComparison() {
    // TODO: Export comparison to PDF/Excel
    alert('Export feature coming soon!');
}

function generateReport() {
    // TODO: Generate detailed report
    alert('Report generation coming soon!');
}

// Search functionality
document.getElementById('search-inventory').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    // TODO: Implement search filtering
});
</script>
{% endblock %}