{% extends "base.html" %}
{% block title %}Kavak Trade-Up - Customer {{ customer.customer_id }}{% endblock %}
{% block content %}
    <header class="main-header">
        <h2>üë§ Customer {{ customer.customer_id }} - Enhanced Analysis</h2>
        <p>Contract: {{ customer.contract_id if customer.contract_id else 'N/A' }} | Deep Dive Trade-Up Engine Analysis <span id="config-status-badge" class="status-badge" style="display:none;"></span></p>
    </header>

    <!-- Enhanced Customer Profile -->
    <div class="section-card">
        <h3>üìã Customer Profile & Financial Data</h3>
        <div class="customer-profile-grid">
            <div class="profile-item">
                <div class="profile-label">Current Car</div>
                <div class="profile-value">{{ customer.current_car_model or 'Unknown' }}</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Current Payment</div>
                <div class="profile-value">${{ "{:,.0f}".format(customer.current_monthly_payment) }}</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Current Car Value</div>
                <div class="profile-value">${{ "{:,.0f}".format(customer.current_car_price) }}</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Vehicle Equity</div>
                <div class="profile-value">${{ "{:,.0f}".format(customer.vehicle_equity) }}</div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Risk Profile</div>
                <div class="profile-value">{{ customer.risk_profile_name }} <span class="info-tooltip" title="Interest Rate: Based on risk profile">?</span></div>
            </div>
            <div class="profile-item">
                <div class="profile-label">Outstanding Balance</div>
                <div class="profile-value">${{ "{:,.0f}".format(customer.outstanding_balance) if customer.outstanding_balance else '0' }}</div>
            </div>
        </div>
    </div>

    <!-- Controls with Filters -->
    <div class="controls-section">
        <div class="customer-selector">
            <label for="customer-select">Select Customer:</label>
            <select id="customer-select" class="form-select">
                <option value="{{ customer.customer_id }}" selected>Customer {{ customer.customer_id }}</option>
            </select>
        </div>
        <select id="mode-select" style="margin-right:10px;">
            <option value="current">Current Mode</option>
            <option value="default">Default</option>
            <option value="custom">Custom</option>
            <option value="range">Range Optimization</option>
        </select>
        <button id="generate-offers-btn" class="btn-primary">Generate Offers</button>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" id="filters-section" style="display: none;">
        <div class="filter-group">
            <label class="filter-label">Term (Months)</label>
            <select id="term-filter" class="form-select">
                <option value="all">All Terms</option>
                <option value="12">12 Months</option>
                <option value="24">24 Months</option>
                <option value="36">36 Months</option>
                <option value="48">48 Months</option>
                <option value="60">60 Months</option>
                <option value="72">72 Months</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Tier</label>
            <select id="tier-filter" class="form-select">
                <option value="all">All Tiers</option>
                <option value="Refresh">Refresh (-5% to +5%)</option>
                <option value="Upgrade">Upgrade (+5% to +25%)</option>
                <option value="Max Upgrade">Max Upgrade (+25% to +100%)</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Min NPV</label>
            <input type="number" id="npv-filter" class="form-input" placeholder="5000" value="0">
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="loading-card" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Running hierarchical subsidy search to find optimal offers...</p>
    </div>

    <!-- Results Section -->
    <div id="results-container">
        <div class="section-card">
            <h3>üìä Offers Summary</h3>
            <div id="offers-summary" class="kpi-grid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Hierarchical Search Explanation -->
        <div class="fee-breakdown-card" id="search-explanation" style="display: none;">
            <h4>üîç Hierarchical Subsidy Search Process</h4>
            <p style="font-size: 14px; margin-top: 10px;">
                The engine searches for valid offers using a hierarchical approach to maximize profitability:
            </p>
            <ol style="font-size: 13px; margin-top: 10px;">
                <li><strong>Phase 1 (Max Profit):</strong> Service Fee 5%, CXA 4%, No CAC Bonus</li>
                <li><strong>Phase 2 Level 1:</strong> Service Fee 0%, CXA 4%, No CAC Bonus</li>
                <li><strong>Phase 2 Level 2:</strong> Service Fee 0%, CXA 4%, CAC Bonus $5,000</li>
                <li><strong>Phase 2 Level 3:</strong> Service Fee 0%, CXA 0%, CAC Bonus $5,000</li>
            </ol>
            <p style="font-size: 12px; margin-top: 10px; color: #6b7280;">
                The search stops as soon as valid offers are found, ensuring maximum profitability.
            </p>
        </div>

        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
            <label for="tier-select" style="margin-right:8px;">Filter Tier:</label>
            <select id="tier-select">
                <option value="all">All</option>
                <option value="Refresh">Refresh</option>
                <option value="Upgrade">Upgrade</option>
                <option value="Max Upgrade">Max Upgrade</option>
            </select>
        </div>
        <div id="offers-by-tier"></div>
    </div>

    <!-- No Results State -->
    <div id="no-results" class="section-card" style="display: none;">
        <div class="no-offers-state">
            <h3>No Valid Offers Found</h3>
            <p>This customer is currently not eligible for any trade-up offers based on the available inventory and current engine configuration.</p>
            <p style="margin-top: 10px; font-size: 14px;">Possible reasons:</p>
            <ul style="font-size: 13px; color: #6b7280;">
                <li>Insufficient equity for down payment requirements</li>
                <li>No cars in inventory meet the payment delta constraints</li>
                <li>NPV threshold not met for available offers</li>
            </ul>
        </div>
    </div>

    <!-- Modal for Amortization Table -->
    <div id="amortization-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAmortizationModal()">&times;</span>
            <h3>Amortization Schedule</h3>
            <div id="amortization-table"></div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const pathParts = window.location.pathname.split('/');
        const customerId = pathParts[pathParts.length - 1];
        if (customerId) {
            initializeCustomerView(customerId);
        }
    });
</script>
{% endblock %}
